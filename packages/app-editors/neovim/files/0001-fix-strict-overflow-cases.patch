From 2f0ae7fcdec2e09975f6765e9375dc159221103d Mon Sep 17 00:00:00 2001
From: Nikolay Orlyuk <virkony@gmail.com>
Date: Sun, 4 May 2014 19:51:31 +0300
Subject: [PATCH] fix strict-overflow cases

---
 src/getchar.c | 15 ++++++---------
 src/undo.c    | 11 ++++++-----
 2 files changed, 12 insertions(+), 14 deletions(-)

diff --git a/src/getchar.c b/src/getchar.c
index a27f5f0..c5bbc78 100644
--- a/src/getchar.c
+++ b/src/getchar.c
@@ -4265,7 +4265,6 @@ check_map (
   int hash;
   int len, minlen;
   mapblock_T  *mp;
-  char_u      *s;
   int local;
 
   validate_maphash();
@@ -4289,17 +4288,15 @@ check_map (
         /* skip entries with wrong mode, wrong length and not matching
          * ones */
         if ((mp->m_mode & mode) && (!exact || mp->m_keylen == len)) {
-          if (len > mp->m_keylen)
-            minlen = mp->m_keylen;
-          else
-            minlen = len;
-          s = mp->m_keys;
-          if (ign_mod && s[0] == K_SPECIAL && s[1] == KS_MODIFIER
+          char_u *s = mp->m_keys;
+          int keylen = mp->m_keylen;
+          if (ign_mod && keylen >= 3
+              && s[0] == K_SPECIAL && s[1] == KS_MODIFIER
               && s[2] != NUL) {
             s += 3;
-            if (len > mp->m_keylen - 3)
-              minlen = mp->m_keylen - 3;
+            keylen -= 3;
           }
+          minlen = keylen < len ? keylen : len;
           if (STRNCMP(s, keys, minlen) == 0) {
             if (mp_ptr != NULL)
               *mp_ptr = mp;
diff --git a/src/undo.c b/src/undo.c
index 243d865..ca1935a 100644
--- a/src/undo.c
+++ b/src/undo.c
@@ -233,8 +233,11 @@ static void u_check(int newhead_may_be_NULL)                 {
  */
 int u_save_cursor(void)
 {
-  return u_save((linenr_T)(curwin->w_cursor.lnum - 1),
-      (linenr_T)(curwin->w_cursor.lnum + 1));
+  linenr_T cur = curwin->w_cursor.lnum;
+  linenr_T top = cur > 0  ? cur - 1 : 0;
+  linenr_T bot = cur + 1;
+
+  return u_save(top, bot);
 }
 
 /*
@@ -248,9 +251,7 @@ int u_save(linenr_T top, linenr_T bot)
   if (undo_off)
     return OK;
 
-  if (top > curbuf->b_ml.ml_line_count
-      || top >= bot
-      || bot > curbuf->b_ml.ml_line_count + 1)
+  if (top >= bot || bot > (curbuf->b_ml.ml_line_count + 1))
     return FALSE;       /* rely on caller to do error messages */
 
   if (top + 2 == bot)
-- 
1.9.2

